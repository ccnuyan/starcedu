{"version":3,"sources":["webpack:///webpack/bootstrap b11638a4e078a6ea98ec","webpack:///./serverConfig/index.js","webpack:///external \"lodash\"","webpack:///external \"chalk\"","webpack:///external \"express\"","webpack:///./_auth/src/services/userServices.js","webpack:///./db/connector.js","webpack:///./_auth/src/services/tokenServices.js","webpack:///./_auth/src/api/paramsValidator.js","webpack:///external \"querystring\"","webpack:///./serverConfig/common.js","webpack:///./serverConfig/tenants/index.js","webpack:///./_auth/src/api/authMiddleware.js","webpack:///external \"jsonwebtoken\"","webpack:///./_auth/src/services/oauthServices.js","webpack:///external \"fs\"","webpack:///external \"path\"","webpack:///external \"babel-polyfill\"","webpack:///./_auth/src/index.js","webpack:///./serverConfig/config.development.js","webpack:///./serverConfig/config.production.js","webpack:///./serverConfig/config.test.js","webpack:///./serverConfig/_auth.config.js","webpack:///./serverConfig/_disk.config.js","webpack:///./_auth/src/api/index.js","webpack:///./_auth/src/api/user/index.js","webpack:///./_auth/src/api/user/me.js","webpack:///./_auth/src/api/user/signin.js","webpack:///external \"pg\"","webpack:///./_auth/src/api/user/signup.js","webpack:///./_auth/src/api/user/signout.js","webpack:///./_auth/src/api/user/update_password.js","webpack:///./_auth/src/api/oauth/index.js","webpack:///./_auth/src/api/oauth/3rd_party_unlink.js","webpack:///./_auth/src/api/oauth/3rd_party_signout.js","webpack:///./_auth/src/api/oauth/tenant_signout.js","webpack:///./_auth/src/api/tenantAuthMiddleware.js","webpack:///./_auth/src/web/index.js","webpack:///./utils/indexFabricator/index.js","webpack:///./_auth/src/web/controllers/oauth/callback.js","webpack:///./_auth/src/web/controllers/oauth/qqMiddleware.js","webpack:///./_auth/src/web/controllers/oauth/goGet.js","webpack:///external \"request\"","webpack:///./_auth/src/web/controllers/oauth/qq.js","webpack:///external \"uuid\"","webpack:///./_auth/src/web/controllers/authorize/index.js","webpack:///./_auth/src/services/authorizeServices.js","webpack:///./_auth/src/auth/sessionMiddleware.js","webpack:///external \"connect-redis\"","webpack:///external \"express-session\"","webpack:///./_auth/src/auth/byPassTenantAuth.js","webpack:///./_auth/src/auth/byPassUserAuth.js"],"names":["configVar","process","env","NODE_ENV","config","appsConfigs","auth","disk","commonKeys","Object","keys","forEach","app","k","mode","appConfig","merge","chalkcontent","grey","red","blue","console","log","authenticate","username","password","oauth_user_id","gen_token","target_tenant","user","query","auth_dbname","then","res","rows","oauth_user","id","token","to","register","dbres","registerInfo","username_check","valid","rowCount","update_password","old_password","new_password","ret","success","message","pg","Pool","yellow","host","port","database","text","params","end","sign","issuer","payload","pick","jwt","secret","expiresIn","verify","validationRules","beforeVal","val","toLowerCase","regex","bind_user_id","unique_provider_id","provider","profile","validate","nonNullParamsArray","status","trim","every","JSON","stringify","test","title","domain","serviceBase","cookie","maxAge","session","minDelay","maxDelay","userHeader","tenantHeader","DB_USER","DB_DATABASE","DB_PASSWORD","DB_HOST","DB_PORT","max","idleTimeoutMillis","redisSessionServer","qiniuBucket","qiniu","bucket","ak","sk","callbackBase","url","stylesheets","normalize","semantic","scripts","jquery","head","html5shiv","classlist","tenants","parse","readFileSync","TENANTS_CONFIG","join","__dirname","t","req","next","send","code","client","get_associated_oauth_users","user_id","get_oauth_user_by_provider_info","add_oauth_user","get_oauth_user","unlink_oauth_user","update_oauth_user","session2Req","api","use","authConfig","tenant","web","DBUSER","DBDATABASE","DBPASSWORD","DBHOST","DBPORT","development","dbname","production","router","get","post","put","me","data","signin","autoSignin","body","valRet","json","oauthUser","pickedUser","expires","callback","signup","signout","unlink","oauthControllers","oauthProviders","qq","ck","cb","authorize","decide","get_token","ignoreArray","path","startsWith","entry","preloadedState","replace","indexFactory","contents","assets","rawIndexHTML","styles","disk_stylesheets","map","key","css","push","disk_scripts","vendor","js","oauth","loginInfo","qqMiddleware","state","grant_type","client_id","app_id","client_secret","app_key","redirect_uri","pcTokenHost","err1","rs1","bd1","access_token","expires_in","refresh_token","pcOpenidHost","err2","rs2","bd2","bodyObject","match","openid","infoHost","oauth_consumer_key","err3","rs3","bd3","goGet","method","uri","headers","Accept","v4","response_type","scope","location","pcCodeHost","redirect","cl","generateCode","codeStruct","redirect_url","exchange_code_for_token","tokenStruct","decodedcode","RedisStore","ssConfig","resave","saveUninitialized","httpOnly","store","green","sessionMiddleware","breaks","split","length","credentials","Buffer","toString","pass","decoded","pres"],"mappings":"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","file":"server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 16);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap b11638a4e078a6ea98ec","import chalk from 'chalk';\nimport _ from 'lodash';\nimport development from './config.development';\nimport production from './config.production';\nimport test from './config.test';\nimport auth from './_auth.config';\nimport disk from './_disk.config';\n\nlet configVar = {};\nif (process.env.NODE_ENV === 'production') {\n  configVar = production;\n} else if (process.env.NODE_ENV === 'test') {\n  configVar = test;\n} else {\n  configVar = development;\n}\nconst config = configVar;\n\nconst appsConfigs = {\n  auth,\n  disk,\n};\n\nconst commonKeys = Object.keys(config);\n\nObject.keys(appsConfigs).forEach((app) => {\n  commonKeys.forEach((k) => {\n    config[`${app}_${k}`] = config[k];\n  });\n});\n\nObject.keys(appsConfigs).forEach((app) => {\n  Object.keys(appsConfigs[app][config.mode]).forEach((k) => {\n    const appConfig = appsConfigs[app][config.mode][k];\n    if (typeof appConfig === 'string') {\n      config[`${app}_${k}`] = appConfig;\n    } else if (typeof config[k] === 'number') {\n      config[`${app}_${k}`] = appConfig;\n    } else if (typeof appConfig === 'object') {\n      if (typeof config[`${app}_${k}`] === 'object') {\n        config[`${app}_${k}`] = _.merge(config[`${app}_${k}`], appConfig);\n      } else {\n        config[`${app}_${k}`] = appConfig;\n      }\n    }\n  });\n});\n\nlet chalkcontent = chalk.grey('running in ');\nchalkcontent += config.mode === 'production' ? chalk.red(config.mode) : chalk.blue(config.mode);\nchalkcontent += chalk.grey(' mode');\n\nconsole.log(chalkcontent); // eslint-disable-line\n\nexport default config;\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/index.js","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"chalk\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"chalk\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"express\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express\"\n// module id = 3\n// module chunks = 0","import pgPool from '../../../db/connector';\nimport { sign } from './tokenServices';\nimport serverConfig from '../../../serverConfig';\n\nconst authenticate = async ({ username, password, oauth_user_id }, { gen_token, target_tenant }) => {\n  let user = {};\n  if (oauth_user_id) {\n    // 对应绑定业务\n    const oauth_user = await pgPool\n      .query(`select * from ${serverConfig.auth_dbname}.oauth2Users where id = $1`, [oauth_user_id])\n      .then(res => res.rows[0]);\n    user = await pgPool\n      .query(`select * from ${serverConfig.auth_dbname}.authenticate($1, $2, $3, $4)`, [username, password, 'local', oauth_user.id])\n      .then(res => res.rows[0]);\n  } else {\n    user = await pgPool\n      .query(`select * from ${serverConfig.auth_dbname}.authenticate($1, $2)`, [username, password])\n      .then(res => res.rows[0]);\n  }\n\n  if (user.id) {\n    if (gen_token) {\n      user.token = sign('local', {\n        to: target_tenant || 'local',\n        ...user,\n      });\n      await pgPool.query(`select * from ${serverConfig.auth_dbname}.add_login($1, $2, $3, $4)`, [user.id, 'token', user.token, 'token']);\n    }\n  }\n  return user;\n};\n\nconst register = async ({ username, password, oauth_user_id }, { gen_token, target_tenant }) => {\n  let user = {};\n  if (oauth_user_id) {\n    // 对应基于第三方账户注册新用户的业务\n    user = await pgPool\n      .query(`select * from ${serverConfig.auth_dbname}.register($1,$2,$3)`, [\n        username,\n        password,\n        oauth_user_id,\n      ])\n      .then((dbres) => {\n        const registerInfo = dbres.rows[0];\n        return registerInfo;\n      });\n  } else {\n    user = await pgPool\n      .query(`select * from ${serverConfig.auth_dbname}.register($1,$2)`, [username, password])\n      .then((dbres) => {\n        const registerInfo = dbres.rows[0];\n        return registerInfo;\n      });\n  }\n  if (user.id) {\n    if (gen_token) {\n      user.token = sign('local', {\n        to: target_tenant || 'local',\n        ...user,\n      });\n      await pgPool.query(`select * from ${serverConfig.auth_dbname}.add_login($1, $2, $3, $4)`, [user.id, 'token', user.token, 'token']);\n    }\n  }\n  return user;\n};\n\nconst username_check = ({ username }) => {\n  return pgPool.query(`select * from ${serverConfig.auth_dbname}.users where username=$1`, [username])\n    .then((res) => {\n      return {\n        valid: res.rowCount < 1,\n        username,\n      };\n    });\n};\n\nconst update_password = ({ username, old_password, new_password }) => {\n  return pgPool.query(`select * from ${serverConfig.auth_dbname}.update_password($1, $2, $3)`, [username, old_password, new_password])\n    .then((res) => {\n      if (res.rowCount === 1) {\n        const ret = res.rows[0];\n        return ret;\n      }\n      return { success: false, message: '密码更新失败' };\n    });\n};\n\nexport default {\n  authenticate,\n  register,\n  username_check,\n  update_password,\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/services/userServices.js","import postgres from 'pg';\nimport chalk from 'chalk';\nimport serverConfig from '../serverConfig';\n\nexport const pg = new postgres.Pool(serverConfig.pg);\n\nconsole.log(chalk.yellow(`DATABASE -> ${serverConfig.pg.host}:${serverConfig.pg.port}/${serverConfig.pg.database}`)); // eslint-disable-line\n\nexport default {\n  query: async (text, params) => {\n    return pg.query(text, params);\n  },\n  end: async () => {\n    return pg.end();\n  },\n};\n\n\n\n// WEBPACK FOOTER //\n// ./db/connector.js","import jwt from 'jsonwebtoken';\nimport _ from 'lodash';\n\nimport serverConfig from '../../../serverConfig';\n\nexport const sign = (issuer, payload) => {\n  const user = _.pick(payload, ['id', 'username', 'to']);\n  return jwt.sign(\n    user,\n    serverConfig.jwt.secret,\n    {\n      expiresIn: serverConfig.jwt.expiresIn,\n      issuer,\n    },\n  );\n};\n\nexport const verify = (token) => {\n  return jwt.verify(token, serverConfig.jwt.secret);\n};\n\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/services/tokenServices.js","const validationRules = {\n  username: {\n    beforeVal: (val) => {\n      return val.toLowerCase();\n    },\n    regex:/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|\"(?:[\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x21\\x23-\\x5b\\x5d-\\x7f]|\\\\[\\x01-\\x09\\x0b\\x0c\\x0e-\\x7f])*\")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x21-\\x5a\\x53-\\x7f]|\\\\[\\x01-\\x09\\x0b\\x0c\\x0e-\\x7f])+)\\])/, //eslint-disable-line\n  },\n  password: {\n    regex: /^[A-Za-z0-9]{6,20}$/,\n  },\n  old_password: {\n    regex: /^[A-Za-z0-9]{6,20}$/,\n  },\n  new_password: {\n    regex: /^[A-Za-z0-9]{6,20}$/,\n  },\n  bind_user_id: {\n  },\n  oauth_user_id: {\n  },\n  unique_provider_id: {\n  },\n  provider: {\n  },\n  profile: {\n  },\n};\n\nconst validate = (payload, nonNullParamsArray) => {\n  const ret = {\n    status: true,\n    message: '',\n  };\n\n  Object.keys(payload).forEach((k) => {\n    if (payload[k] && typeof payload[k] === 'string') {\n      payload[k] = payload[k].trim(); // eslint-disable-line no-param-reassign\n    }\n    if (payload[k] && validationRules[k] && validationRules[k].beforeVal) {\n      payload[k] = validationRules[k].beforeVal(payload[k]); // eslint-disable-line no-param-reassign\n    }\n  });\n\n  nonNullParamsArray.every((k) => {\n    if (!validationRules[k]) {\n      console.log(`no validation rule for non-null parameter ${k} in \\n)${JSON.stringify(payload, null, 2)}`); // eslint-disable-line\n    } else if (!payload[k]) {\n      ret.status = false;\n      ret.message = `${k} empty`;\n      return false;\n    }\n    return true;\n  });\n\n  if (!ret.status) {\n    return ret;\n  }\n\n  Object.keys(payload).every((k) => {\n    if (!validationRules[k]) {\n      // console.log(`no validation rule for parameter ${k} in \\n)${JSON.stringify(payload, null, 2)}`);\n    } else if (!validationRules[k].regex) {\n      // console.log(`no regex rule for parameter ${k}`);\n    } else if (!validationRules[k].regex.test(payload[k])) {\n      ret.status = false;\n      ret.message = `provided ${k} illigal`;\n      return false;\n    }\n    return true;\n  });\n\n  return ret;\n};\n\nexport default {\n  validate,\n  validationRules,\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/paramsValidator.js","module.exports = require(\"querystring\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"querystring\"\n// module id = 8\n// module chunks = 0","/*\n * no true/false\n * no underline\n * no functions\n * overide by config.[mode].js\n * overide by _app.config.js\n */\n\nexport default {\n  title: 'starC教育',\n  port: 8000,\n  domain: 'www.syncollege.com',\n  serviceBase: '/',\n  cookie: {\n    maxAge: 14 * 24 * 3600 * 1000,\n  },\n  session: {\n    secret: '12345678',\n  },\n  minDelay: 0,\n  maxDelay: 0,\n  jwt: {\n    secret: '12345678',\n  },\n  userHeader: 'authorization',\n  tenantHeader: 'starcedu-tenant-authorization',\n  pg: {\n    user: process.env.DB_USER ? process.env.DB_USER : 'postgres',\n    database: process.env.DB_DATABASE ? process.env.DB_DATABASE : 'postgres',\n    password: process.env.DB_PASSWORD ? process.env.DB_PASSWORD : '',\n    host: process.env.DB_HOST ? process.env.DB_HOST : 'localhost',\n    port: process.env.DB_PORT ? process.env.DB_PORT : 5432,\n    max: 10,\n    idleTimeoutMillis: 30000,\n  },\n  redisSessionServer: {\n    host: 'localhost',\n    port: 6379,\n  },\n  qiniuBucket: '7xt1pi.com1.z0.glb.clouddn.com',\n  qiniu: {\n    bucket: 'test',\n    mode: 'direct',\n    ak: 'JK2nEgwnvAoWh4e7hWyUX3Iuc6fs8-6vL5xNu-kq',\n    sk: 'LRKdhh_0T4l_w6q1rbA2T-rNolTogMMjXihigG8x',\n    callbackBase: 'http://www.syncollege.com/',\n    url: 'http://7xt1pi.com1.z0.glb.clouddn.com',\n  },\n  stylesheets: {\n    normalize: '//cdn.bootcss.com/normalize/6.0.0/normalize.min.css',\n    semantic: '/static/semantic/semantic.min.css',\n  },\n  scripts: {\n    jquery: '//cdn.bootcss.com/jquery/3.2.1/jquery.min.js',\n    head: '//cdn.bootcss.com/headjs/1.0.3/head.min.js',\n    html5shiv: '//cdn.bootcss.com/html5shiv/r29/html5.min.js',\n    classlist: '//cdn.bootcss.com/classlist/2014.01.31/classList.min.js',\n    semantic: '/static/semantic/semantic.min.js',\n  },\n};\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/common.js","import fs from 'fs';\nimport path from 'path';\n\nconst tenants = JSON.parse(fs.readFileSync(process.env.TENANTS_CONFIG || path.join(__dirname, './tenants.json'), 'utf-8'));\n\nObject.keys(tenants).forEach((t) => {\n  tenants[t].id = t;\n});\n\nexport default tenants;\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/tenants/index.js","export default (req, res, next) => {\n  if (req.user && req.user.id) {\n    return next();\n  }\n  return res.status(401).send({\n    code: 401,\n    message: 'user unauthenticated',\n  });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/authMiddleware.js","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 12\n// module chunks = 0","import { sign } from './tokenServices';\nimport serverConfig from '../../../serverConfig';\nimport pgPool from '../../../db/connector';\n\nconst authenticate = async ({ unique_provider_id, provider, client }) => {\n  let user = {};\n  user = await pgPool.query(`select * from ${serverConfig.auth_dbname}.oauth_authenticate($1, $2)`, [unique_provider_id, provider]) // eslint-disable-line max-len\n    .then((res) => {\n      if (res.rowCount === 1) {\n        return res.rows[0];\n      }\n      return { success: false };\n    });\n\n  if (user.id) {\n    const token = sign('local', {\n      to: client || 'local',\n      user,\n    });\n    user.token = token;// 添加login\n    await pgPool.query(`select * from ${serverConfig.auth_dbname}.add_login($1, $2, $3, $4)`, [user.id, unique_provider_id, token, provider]); // eslint-disable-line max-len\n    return user;\n  }\n  return { success: false };\n};\n\n\nconst get_associated_oauth_users = ({ user_id }) => {\n  return pgPool.query(`select * from ${serverConfig.auth_dbname}.oauth2users where user_id = $1`, [user_id])\n    .then((res) => {\n      return res.rows;\n    });\n};\n\nconst get_oauth_user_by_provider_info = ({ unique_provider_id, provider }) => {\n  return pgPool.query(`select * from ${serverConfig.auth_dbname}.oauth2users where unique_provider_id = $1 and provider = $2`, [unique_provider_id, provider])\n    .then((res) => {\n      if (res.rowCount === 1) {\n        return res.rows[0];\n      }\n      return false;\n    });\n};\n\nconst add_oauth_user = ({ provider, unique_provider_id, profile }) => {\n  return pgPool.query(`insert into ${serverConfig.auth_dbname}.oauth2users(unique_provider_id, provider, profile) values ($1,$2,$3) returning *`, [unique_provider_id, provider, profile]) // eslint-disable-line max-len\n    .then((res) => {\n      if (res.rowCount === 1) {\n        return res.rows[0];\n      }\n      return { success: false };\n    });\n};\n\nconst get_oauth_user = ({ oauth_user_id }) => {\n  return pgPool.query(`select * from ${serverConfig.auth_dbname}.oauth2users where id = $1`, [oauth_user_id])\n    .then((res) => {\n      if (res.rowCount === 1) {\n        return res.rows[0];\n      }\n      return { success: false };\n    });\n};\n\nconst unlink_oauth_user = ({ oauth_user_id, bind_user_id }) => {\n  return pgPool.query(`select * from ${serverConfig.auth_dbname}.unlink_oauth_user($1, $2)`, [oauth_user_id, bind_user_id])\n    .then((res) => {\n      return res.rows;\n    });\n};\n\nconst update_oauth_user = ({ unique_provider_id, provider, profile }) => {\n  return pgPool.query(`update ${serverConfig.auth_dbname}.oauth2users set profile=$3 where unique_provider_id=$1 and provider=$2 returning *`, [unique_provider_id, provider, profile]) // eslint-disable-line\n    .then((res) => {\n      if (res.rowCount === 1) {\n        return res.rows[0];\n      }\n      return { success: false };\n    });\n};\n\n\nexport default {\n  get_oauth_user,\n  get_oauth_user_by_provider_info,\n  get_associated_oauth_users,\n  add_oauth_user,\n  unlink_oauth_user,\n  update_oauth_user,\n  authenticate,\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/services/oauthServices.js","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 14\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 15\n// module chunks = 0","module.exports = require(\"babel-polyfill\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-polyfill\"\n// module id = 17\n// module chunks = 0","import serverConfig from '../../serverConfig';\n\nimport api from '../src/api/';\nimport web from '../src/web/';\n\nimport session from './auth/sessionMiddleware';\nimport tenantAuth from './auth/byPassTenantAuth';\nimport userAUth from './auth/byPassUserAuth';\n\nconst session2Req = (req, res, next) => {\n  Object.keys(req.session).forEach((k) => { if (k !== 'cookie') req[k] = req.session[k]; });\n  next();\n};\n\nexport default {\n  api: (app) => {\n    app.use('/api/local/*',\n      session,\n      session2Req,\n      (req, res, next) => {\n        req.authConfig = { gen_token: false };\n        next();\n      });\n\n    app.use('/api/tenant/*',\n      userAUth,\n      tenantAuth,\n      (req, res, next) => {\n        req.authConfig = {\n          gen_token: true,\n          target_tenant: req.tenant ? req.tenant.id : 'local',\n        };\n        next();\n      });\n\n    api(app);\n\n    app.use('/api/status', (req, res) => {\n      res.status(200).send({\n        message: 'service ok',\n      });\n    });\n    app.use('/api/*', (req, res) => {\n      res.status(404).send({\n        message: 'no such business',\n      });\n    });\n  },\n  web: (app) => {\n    if (serverConfig.mode !== 'test') {\n      app.use('/*', session, session2Req);\n      web(app);\n    }\n  },\n};\n\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/index.js","import common from './common';\n\nexport default {\n  ...common,\n  mode: 'development',\n  log: 'tiny',\n  minDelay: 300,\n  maxDelay: 1000,\n};\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/config.development.js","import common from './common';\n\nexport default {\n  ...common,\n  pg: {\n    user: process.env.DBUSER ? process.env.DBUSER : 'postgres',\n    database: process.env.DBDATABASE ? process.env.DBDATABASE : 'postgres',\n    password: process.env.DBPASSWORD ? process.env.DBPASSWORD : '',\n    host: process.env.DBHOST ? process.env.DBHOST : 'database',\n    port: process.env.DBPORT ? process.env.DBPORT : 5432,\n    max: 10,\n    idleTimeoutMillis: 30000,\n  },\n  mode: 'production',\n};\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/config.production.js","import common from './common';\n\nexport default {\n  ...common,\n  mode: 'test',\n};\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/config.test.js","export default {\n  development: {\n    dbname: 'starcedu_auth', port: 8000,\n  },\n  production: {\n    dbname: 'starcedu_auth',\n  },\n  test: {\n    dbname: 'starcedu_auth',\n    port: 8001,\n  },\n};\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/_auth.config.js","export default {\n  development: {\n    dbname: 'starcedu_disk', port: 18000,\n  },\n  production: {\n    dbname: 'starcedu_disk',\n  },\n  test: {\n    dbname: 'starcedu_disk',\n    port: 18001,\n  },\n};\n\n\n\n// WEBPACK FOOTER //\n// ./serverConfig/_disk.config.js","import user from './user';\nimport oauth from './oauth';\nimport tenantAuthMiddleware from './tenantAuthMiddleware';\n\nexport default (app) => {\n  app.use('/api/local/user', user);\n  app.use('/api/local/oauth', oauth);\n  app.use('/api/tenant/user', tenantAuthMiddleware, user);\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/index.js","import { Router } from 'express';\n\nimport auth from '../authMiddleware';\nimport me from './me';\nimport signin from './signin';\nimport signup from './signup';\nimport signout from './signout';\nimport update_password from './update_password';\n\nconst router = Router();\n\nrouter.get('/me', auth, me);\nrouter.post('/signin', signin);\nrouter.post('/signup', signup);\nrouter.get('/signout', signout);\nrouter.put('/update_password', auth, update_password);\n\nexport default router;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/user/index.js","const me = async (req, res) => {\n  if (req.session.user) {\n    return res.status(200).send({\n      message: 'success',\n      data: req.session.user,\n    });\n  }\n  res.status(401).send({\n    message: 'Unauthenticated',\n  });\n};\n\nexport default me;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/user/me.js","import _ from 'lodash';\n\nimport serverConfig from '../../../../serverConfig';\nimport userServices from '../../services/userServices';\nimport paramsValidator from '../paramsValidator';\n\nconst signin = async (req, res) => {\n  const payload = {\n    autoSignin: req.body.autoSignin,\n    username: req.body.username,\n    password: req.body.password,\n  };\n\n  const valRet = paramsValidator.validate(payload, ['username', 'password']);\n  if (!valRet.status) {\n    return res.status(400).json(valRet);\n  }\n\n  if (req.oauthUser && req.oauthUser.id) {\n    payload.oauth_user_id = req.session.oauthUser.id;\n  }\n\n  const ret = await userServices.authenticate(payload, req.authConfig);\n  const pickedUser = _.pick(ret, ['username', 'id', 'token']);\n\n  if (ret.success) {\n    if (req.session) {\n      req.session.user = pickedUser;\n      if (payload.autoSignin === true) {\n        req.session.cookie.maxAge = serverConfig.cookie.maxAge;\n      } else {\n        req.session.cookie.expires = false;\n      }\n      // if there is a tenant, save the callback for the case callback from 3rd party provider.\n      req.session.callback = '/';\n    }\n    res.json({\n      data: {\n        ...pickedUser,\n        // if there is a tenant, to decide is the first priority.\n        callback: req.callback,\n      },\n      message: ret.message,\n    });\n  } else {\n    if (req.session) {\n      req.session.user = {};\n    }\n    res.status(400).json({\n      message: ret.message,\n    });\n  }\n};\n\nexport default signin;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/user/signin.js","module.exports = require(\"pg\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"pg\"\n// module id = 28\n// module chunks = 0","import _ from 'lodash';\nimport userServices from '../../services/userServices';\nimport paramsValidator from '../paramsValidator';\n\nconst signup = async (req, res) => {\n  const payload = {\n    username: req.body.username,\n    password: req.body.password,\n  };\n\n  const valRet = paramsValidator.validate(payload, ['username', 'password']);\n  if (!valRet.status) {\n    return res.status(400).json(valRet);\n  }\n\n  if (req.oauthUser && req.oauthUser.id) {\n    payload.oauth_user_id = req.oauthUser.id;\n  }\n\n  const ret = await userServices.register(payload, req.authConfig);\n  const pickedUser = _.pick(ret, ['username', 'id', 'token']);\n\n  if (ret.success) {\n    if (req.session) {\n      req.session.oauthUser = {};\n      req.session.user = ret;\n    }\n    res.json({\n      data: pickedUser,\n      message: ret.message,\n    });\n  } else {\n    if (req.session) {\n      req.session.oauthUser = {};\n      req.session.user = {};\n    }\n    res.status(400).json({\n      message: ret.message,\n    });\n  }\n};\n\nexport default signup;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/user/signup.js","const signout = (req, res) => {\n  req.session.oauthUser = {};\n  req.session.user = {};\n  res.json({\n    message: 'user session reset',\n  });\n};\n\nexport default signout;\n\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/user/signout.js","import userServices from '../../services/userServices';\nimport paramsValidator from '../paramsValidator';\n\nconst update_password = async (req, res) => {\n  const payload = {\n    old_password: req.body.old_password,\n    new_password: req.body.new_password,\n  };\n\n  payload.username = req.user.username;\n\n  const valRet = paramsValidator.validate(payload, ['old_password', 'new_password']);\n  if (!valRet.status) {\n    return res.status(400).json(valRet);\n  }\n\n  const ret = await userServices.update_password(payload);\n\n  if (ret.success) {\n    if (req.session) {\n      req.session.user = {};\n    }\n    res.status(200).json({\n      data: ret,\n      message: ret.message,\n    });\n  } else {\n    res.status(400).json({\n      message: ret.message,\n    });\n  }\n};\n\nexport default update_password;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/user/update_password.js","import { Router } from 'express';\n\nimport unlink from './3rd_party_unlink';\nimport signout from './3rd_party_signout';\nimport tenant_signout from './tenant_signout';\nimport auth from '../authMiddleware';\n\nconst router = Router();\n\n// these are for 3rd party authentication providers\nrouter.get('/3rd_party_signout', signout);\nrouter.put('/3rd_party_unlink', auth, unlink);\n\n// these are for tennants\nrouter.get('/tenant_signout', tenant_signout);\n\nexport default router;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/oauth/index.js","import oauthServices from '../../services/oauthServices';\nimport userServices from '../../services/userServices';\nimport paramsValidator from '../paramsValidator';\n\nconst unlink = async (req, res) => {\n  const payload = {\n    bind_user_id: req.session.user.id,\n    oauth_user_id: req.body.oauth_user_id,\n    password: req.body.password,\n  };\n\n  if (!paramsValidator.validate(payload,\n    ['bind_user_id', 'oauth_user_id', 'password'],\n    res)) {\n    return;\n  }\n\n  const ret = await userServices.authenticate({\n    username: payload.bind_user_id,\n    password: payload.password,\n  }, {\n    gen_token: false,\n  });\n\n  if (ret.success) {\n    await oauthServices.unlink_oauth_user({\n      bind_user_id: req.user.id,\n      oauth_user_id: req.body.oauth_user_id,\n      password: req.body.password,\n    });\n    res.status(400).json({\n      data: ret,\n      message: 'oauth user unlink successfully',\n    });\n  } else {\n    res.status(400).json({\n      message: 'password invalid',\n    });\n  }\n};\n\nexport default unlink;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/oauth/3rd_party_unlink.js","const signout = (req, res) => {\n  req.session.oauthUser = {};\n  res.json({\n    message: 'oauth session reset',\n  });\n};\n\nexport default signout;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/oauth/3rd_party_signout.js","const signout = (req, res) => {\n  req.session.tenant = {};\n  res.json({\n    message: 'tenant session reset',\n  });\n};\n\nexport default signout;\n\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/oauth/tenant_signout.js","export default (req, res, next) => {\n  if (req.tenant && req.tenant.id) {\n    return next();\n  }\n  res.status(401).send({\n    code: 401,\n    message: 'tenant unauthenticated',\n  });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/api/tenantAuthMiddleware.js","import _ from 'lodash';\n\nimport indexFabricator from '../../../utils/indexFabricator';\nimport callback from './controllers/oauth/callback';\nimport qq from './controllers/oauth/qq';\nimport authorize from './controllers/authorize';\n\nconst oauthControllers = { callback };\nconst oauthProviders = { qq };\n\nexport default (app) => {\n  Object.keys(oauthControllers).forEach((ck) => {\n    app.use(`/oauth/${ck}`, (req, res, next) => {\n      return oauthControllers[ck](req, res, next);\n    }); // notice here is use not route\n  });\n\n  Object.keys(oauthProviders).forEach((ck) => {\n    app.use(`/oauth/luanch/${ck}`, (req, res, next) => {\n      return oauthProviders[ck](req, res, next);\n    }); // notice here is use not route\n  });\n\n  app.get('/user/signin', (req, res, next) => {\n    if (req.query.cb) {\n      if (req.session) {\n        req.session.callback = req.query.cb;\n      }\n    } else {\n      if (req.session) { // eslint-disable-line\n        req.session.callback = '/';\n      }\n    }\n    next();\n  });\n\n  app.get('/user/authorize', authorize.authorize);\n  app.post('/user/decide', authorize.decide);\n  app.post('/user/token_by_code', authorize.get_token);\n\n  app.get('/*', async (req, res) => {\n    // clear short-term session\n    const ignoreArray = [\n      '/oauth/callback',\n      '/user/authorize',\n    ];\n\n    if (_.every(ignoreArray, entry => !req.path.startsWith(entry))) {\n      req.session.tenant = {};\n      req.session.oauthUser = {};\n    }\n\n    Object.keys(req.session).forEach((k) => {\n      if (k !== 'cookie')req[k] = req.session[k];\n    });\n\n    // preloaded store object\n    const preloadedState = {\n      user: {\n        user: req.user || {},\n        oauthUser: req.oauthUser || {},\n        tenant: req.tenant || {},\n        callback: req.callback,\n      },\n    };\n\n    res.send(indexFabricator('auth').replace('_starc_server_state_', JSON.stringify(preloadedState, null, 2)));\n  });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/web/index.js","import fs from 'fs';\nimport path from 'path';\n\nimport serverConfig from '../../serverConfig';\n\nconst indexFactory = {\n\n};\n\nexport default (app) => {\n  if (!indexFactory[app]) {\n    const contents = fs.readFileSync(path.join(__dirname, '../../build/assets.json'), 'utf-8');\n\n    // Define to JSON type\n    const assets = JSON.parse(contents);\n\n    let rawIndexHTML = fs.readFileSync(path.join(__dirname, './index.html'), 'utf-8');\n\n    rawIndexHTML = rawIndexHTML.replace('_starc_edu_title_', serverConfig.title);\n\n    // styles\n\n    const styles =\n      Object.keys(serverConfig.disk_stylesheets).map(key => (\n        `<link href=\"${serverConfig.disk_stylesheets[key]}\" rel=\"stylesheet\"/>`));\n    if (assets[app].css) {\n      styles.push(`<link href=\"${assets[app].css}\" rel=\"stylesheet\"/>`);\n    }\n    rawIndexHTML = rawIndexHTML.replace('_starc_edu_styles_', styles.join('\\n'));\n\n    // scripts\n\n    const scripts =\n      Object.keys(serverConfig.disk_scripts).map(key => (\n        `<script src=\"${serverConfig.disk_scripts[key]}\"></script>`));\n    scripts.push(`<script src=\"${assets.vendor.js}\"></script>`);\n\n    if (assets[app].js) {\n      scripts.push(`<script src=\"${assets[app].js}\"></script>`);\n    }\n    scripts.push(`<script src=\"${assets[app].js}\"></script>`);\n\n    rawIndexHTML = rawIndexHTML.replace('_starc_edu_scripts_', scripts.join('\\n'));\n\n    // register\n\n    indexFactory[app] = rawIndexHTML;\n  }\n\n  return indexFactory[app];\n};\n\n\n\n\n// WEBPACK FOOTER //\n// ./utils/indexFabricator/index.js","import { Router } from 'express';\n\nimport qqMiddleware from './qqMiddleware';\nimport oauthServices from '../../../services/oauthServices';\n\nconst router = Router();\n\nrouter.get('/qq', qqMiddleware);\n\nrouter.get('/:vender', async (req, res, next) => {\n  /*\n    req.oauth:{\n      provider,\n      unique_provider_id\n    }\n  */\n  let oauthUser = await oauthServices.get_oauth_user_by_provider_info({\n    unique_provider_id: req.oauth.unique_provider_id,\n    provider: req.oauth.provider,\n  });\n\n  // 无oauth登录记录\n  if (!oauthUser) {\n    const ret = await oauthServices.add_oauth_user({\n      unique_provider_id: req.oauth.unique_provider_id,\n      provider: req.oauth.provider,\n      profile: req.oauth.profile,\n    });\n    oauthUser = ret;\n  }\n\n  if (!oauthUser.user_id) {\n    // oauth未绑定\n    req.session.oauthUser = oauthUser;\n    next();\n  } else {\n    // oauth登录过且已绑定\n    req.session.oauthUser = {};\n    const payload = ({\n      unique_provider_id: req.oauth.unique_provider_id,\n      provider: req.oauth.provider,\n    });\n    const loginInfo = await oauthServices.authenticate(payload);\n    req.session.user = loginInfo;\n    next();\n  }\n});\n\nexport default router;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/web/controllers/oauth/callback.js","import querystring from 'querystring';\nimport serverConfig from '../../../../../serverConfig';\nimport goGet from './goGet';\n\nconst qqMiddleware = (req, res, next) => {\n  // ref http://wiki.connect.qq.com/oauth2-0%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3\n  const { state, code } = req.query;\n\n  // TODO verify state\n  const query = {\n    grant_type: 'authorization_code',\n    state,\n    code,\n    client_id: serverConfig.oauth.qq.app_id,\n    client_secret: serverConfig.oauth.qq.app_key,\n    redirect_uri: serverConfig.oauth.qq.redirect_uri,\n  };\n\n  // go get the token\n  goGet(serverConfig.oauth.qq.pcTokenHost, query, (err1, rs1, bd1) => {\n    if (err1) {\n      return next(err1);\n    }\n\n    const { access_token, expires_in, refresh_token } = querystring.parse(bd1); // eslint-disable-line\n\n    // go get the openid\n    goGet(serverConfig.oauth.qq.pcOpenidHost, { access_token }, (err2, rs2, bd2) => {\n      if (err2) {\n        return next(err2);\n      }\n      const bodyObject = JSON.parse(bd2.match(/{.+}/)[0]);\n      const openid = bodyObject.openid;\n\n      req.oauth = {\n        provider: 'qq',\n        qq: {\n          openid,\n          access_token,\n        },\n      };\n\n      // go get the user info\n      goGet(serverConfig.oauth.qq.infoHost, {\n        openid,\n        oauth_consumer_key: serverConfig.oauth.qq.app_id,\n        access_token,\n      }, (err3, rs3, bd3) => { // eslint-disable-line\n        if (err3) {\n          return next(err3);\n        }\n\n        /*\n          { ret: 0,\n          msg: '',\n          is_lost: 0,\n          nickname: '严程序',\n          gender: '男',\n          province: '湖北',\n          city: '武汉',\n          year: '1983',\n          figureurl: 'http://qzapp.qlogo.cn/qzapp/101271080/DC2161A5A64497EDC71552DF6850E092/30',\n          figureurl_1: 'http://qzapp.qlogo.cn/qzapp/101271080/DC2161A5A64497EDC71552DF6850E092/50',\n          figureurl_2: 'http://qzapp.qlogo.cn/qzapp/101271080/DC2161A5A64497EDC71552DF6850E092/100',\n          figureurl_qq_1: 'http://q.qlogo.cn/qqapp/101271080/DC2161A5A64497EDC71552DF6850E092/40',\n          figureurl_qq_2: 'http://q.qlogo.cn/qqapp/101271080/DC2161A5A64497EDC71552DF6850E092/100',\n          is_yellow_vip: '0',\n          vip: '0',\n          yellow_vip_level: '0',\n          level: '0',\n          is_yellow_year_vip: '0' }\n        */\n\n        req.oauth = {\n          provider: 'qq',\n          unique_provider_id: openid,\n          profile: bd3,\n        };\n\n        next('route');\n      });\n    });\n  });\n};\n\nexport default qqMiddleware;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/web/controllers/oauth/qqMiddleware.js","import querystring from 'querystring';\nimport request from 'request';\n\n/**\n * goGet - sugar for request\n *\n * @param  {type} url      url to request\n * @param  {type} params   params object in query\n * @param  {type} callback callback function\n * @return {type}          undefined\n */\nfunction goGet(url, params, callback) {\n  request({\n    method: 'GET',\n    uri: `${url}?${querystring.stringify(params)}`,\n    json: true,\n    headers: {\n      Accept: 'application/json',\n      'Content-Type': 'application/json',\n    },\n  }, callback);\n}\n\nexport default goGet;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/web/controllers/oauth/goGet.js","module.exports = require(\"request\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"request\"\n// module id = 42\n// module chunks = 0","import { Router } from 'express';\nimport uuid from 'uuid';\nimport querystring from 'querystring';\n\nimport serverConfig from '../../../../../serverConfig';\n\nconst router = Router();\n\nrouter.get('/', (req, res) => {\n  const state = uuid.v4();\n\n  const query = {\n    response_type: 'code',\n    scope: 'get_user_info',\n    client_id: serverConfig.oauth.qq.app_id,\n    redirect_uri: serverConfig.oauth.qq.redirect_uri,\n    state,\n  };\n  const location = `${serverConfig.oauth.qq.pcCodeHost}?${querystring.stringify(query)}`;\n  res.redirect(location);\n});\n\nexport default router;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/web/controllers/oauth/qq.js","module.exports = require(\"uuid\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"uuid\"\n// module id = 44\n// module chunks = 0","import _ from 'lodash';\n\nimport querystring from 'querystring';\nimport tenants from '../../../../../serverConfig/tenants';\n\nimport authorizeServices from '../../../services/authorizeServices';\n\nconst authorize = async (req, res, next) => {\n  if (req.query.tenant && req.query.state) {\n    const cl = req.query.tenant;\n    if (tenants[cl]) {\n      const tenant = _.pick(tenants[cl], ['id', 'title', 'description', 'redirect_url', 'home_url']);\n      req.session.tenant = {\n        state: req.query.state,\n        ...tenant,\n      };\n    }\n  }\n  next();\n};\n\nconst decide = async (req, res, next) => {\n  if (!req.session.tenant) {\n    return res.redirect('/error');\n  }\n  const payload = {\n    tenant: req.tenant.id,\n    state: req.tenant.state,\n    user_id: req.user.id,\n  };\n  req.session.tenant = {};\n\n  const codeStruct = await authorizeServices.generateCode(payload);\n  if (codeStruct.success) {\n    const tenant = tenants[codeStruct.tenant];\n    const query = querystring.stringify({\n      code: codeStruct.code,\n      state: codeStruct.state,\n    });\n    return res.redirect(`${tenant.redirect_url}?${query}`);\n  }\n  next();\n};\n\nconst get_token = async (req, res) => {\n  let tokenStruct = await authorizeServices.exchange_code_for_token({ code: req.body.code, token: req.body.token });\n  if (tokenStruct.success) {\n    tokenStruct = _.pick(tokenStruct, ['id', 'username', 'token']);\n    return res.send({\n      ...tokenStruct,\n    });\n  }\n  return res.send({\n    ...tokenStruct,\n    message: 'get token error',\n  });\n};\n\nexport default {\n  authorize,\n  decide,\n  get_token,\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/web/controllers/authorize/index.js","import jsonwebtoken from 'jsonwebtoken';\n\nimport serverConfig from '../../../serverConfig';\nimport tenants from '../../../serverConfig/tenants';\nimport pgPool from '../../../db/connector';\nimport { sign } from './tokenServices';\n\nconst generateCode = async ({ tenant, state, user_id }) => {\n  return pgPool.query(`insert into ${serverConfig.auth_dbname}.authorization_codes (tenant, state,  user_id) values ($1, $2, $3) returning *`, [tenant, state, user_id]) // eslint-disable-line max-len\n    .then((res) => {\n      if (res.rowCount === 1) {\n        return { success: true, ...res.rows[0] };\n      }\n      return { success: false };\n    });\n};\n\nconst exchange_code_for_token = async ({ code, token }) => {\n  const codeStruct = await pgPool.query(`select * from ${serverConfig.auth_dbname}.authorization_codes where code=$1`, [code]).then((res) => {\n    if (res.rowCount === 1) {\n      return { success: true, ...res.rows[0] };\n    }\n    return { success: false };\n  });\n  if (!codeStruct.success) { return { success: false }; }\n\n  const decodedcode = jsonwebtoken.verify(token, tenants[codeStruct.tenant].key);\n  if (decodedcode !== code) { return { success: false }; }\n\n  const user = await pgPool.query(`select * from ${serverConfig.auth_dbname}.users where id=$1`, [codeStruct.user_id]).then(res => res.rows[0]);\n\n  user.token = sign('local', { to: codeStruct.tenant, ...user });\n\n  await pgPool.query(`select * from ${serverConfig.auth_dbname}.add_login($1, $2, $3, $4)`, [user.id, 'token', user.token, 'token']);\n  await pgPool.query(`delete from ${serverConfig.auth_dbname}.authorization_codes where code=$1`, [code]);\n\n  return {\n    success: true,\n    ...user,\n  };\n};\n\n\nexport default {\n  generateCode,\n  exchange_code_for_token,\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/services/authorizeServices.js","import connectRedis from 'connect-redis';\nimport session from 'express-session';\nimport chalk from 'chalk';\n\nimport serverConfig from '../../../serverConfig';\n\nconst RedisStore = connectRedis(session);\n\nconst ssConfig = {\n  secret: serverConfig.session.secret,\n  resave: true,\n  saveUninitialized: true,\n  cookie: {\n    httpOnly: true,\n  },\n};\n\nif (serverConfig.mode !== 'test') {\n  ssConfig.store = new RedisStore(serverConfig.redisSessionServer);\n  console.log(chalk.green(`SESSION --> ${serverConfig.redisSessionServer.host}:${serverConfig.redisSessionServer.port}`)); // eslint-disable-line\n} else {\n  console.log(chalk.green('SESSION --> server memory')); // eslint-disable-line\n}\n\nconst sessionMiddleware = session(ssConfig);\n\nexport default sessionMiddleware;\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/auth/sessionMiddleware.js","module.exports = require(\"connect-redis\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"connect-redis\"\n// module id = 48\n// module chunks = 0","module.exports = require(\"express-session\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express-session\"\n// module id = 49\n// module chunks = 0","/*\n  this middleware won't interupt the anonymous accessing\n*/\nimport serverConfig from '../../../serverConfig';\nimport tenants from '../../../serverConfig/tenants';\n\nexport default async (req, res, next) => {\n  // no authorization token: bypass\n  if (!req.headers[serverConfig.tenantHeader]) { return next(); }\n  // authorization not in right format: bypass\n  const breaks = req.headers[serverConfig.tenantHeader].split(' ');\n  if (breaks.length !== 2) { return next(); }\n  if (breaks[1] === 'null' || breaks[1] === 'undefined') { return next(); }\n\n    // tenant basic authentication\n  if (breaks[0] === 'basic') {\n    const credentials = new Buffer(breaks[1], 'base64').toString().split(':');\n    if (credentials.length === 2) {\n        // validataion\n      if (tenants[credentials[0]] && tenants[credentials[0]].pass === credentials[1]) {\n        req.tenant = tenants[credentials[0]];\n      }\n    }\n  }\n  next();\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/auth/byPassTenantAuth.js","/*\n  this middleware won't interupt the anonymous accessing\n*/\nimport chalk from 'chalk';\n\nimport serverConfig from '../../../serverConfig';\nimport { verify } from '../../src/services/tokenServices';\nimport pgPool from '../../../db/connector';\n\nexport default async (req, res, next) => {\n  // no authorization token: bypass\n  if (!req.headers[serverConfig.userHeader]) { return next(); }\n  // authorization not in right format: bypass\n  const breaks = req.headers[serverConfig.userHeader].split(' ');\n  if (breaks.length !== 2) { return next(); }\n  if (breaks[1] === 'null' || breaks[1] === 'undefined') { return next(); }\n\n  try {\n    // user token authentication\n    if (breaks[0] === 'bearer') {\n      const decoded = verify(breaks[1]);\n      const pres = await pgPool\n        .query(`select * from ${serverConfig.dbname}.authenticate($1, $2, $3)`, ['token', breaks[1], 'token'])\n        .then(ret => ret.rows[0]);\n\n      if (pres.success) {\n        req.user = decoded;\n      }\n    }\n  } catch (err) {\n    console.log(chalk.red(err)); // eslint-disable-line \n  } finally {\n    next();\n  }\n};\n\n\n\n// WEBPACK FOOTER //\n// ./_auth/src/auth/byPassUserAuth.js"],"sourceRoot":""}